---
title: "visualisation"
format: html
editor: visual
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup

```{r libs}
library(tidyverse)
library(extrafont)
library(janitor)
library(patchwork)
library(ggrepel)
```

## Importing data

```{r massaging-variables-figure4}
figure4proper <- figure4 |> 
  
  # round the values and put them into percentage point format
  mutate(across(where(is.numeric), ~round(. * 100))) |> 
  select(-contains("weight")) |> 
  
  rename(
    type = big_type,
    response = typ,
    percentage = prop,
    percentage_type = prob_big,
    year = survey 
  ) |> 
  select(response, type, percentage, percentage_type, everything()) |> 
  mutate(
    response = case_when(
      response == "Irrelevant" ~ "Marriage is irrelevant",
      response == "Refusal" ~ "Refusal of marriage",
      response == "Economic" ~ "Economic reasons",
      response == "Trial" ~ "Trial marriage",
      response == "Prelude" ~ "Prelude to marriage",
      TRUE ~ response
    )
  ) |> 
  
  # Block of code for calculating pp change between rounds on responses
  left_join(
    figure4 |>
      mutate(across(where(is.numeric), ~round(. * 100))) |> 
      rename(
        response = typ,
        percentage = prop,
        year = survey
      ) |> 
      mutate(
        response = case_when(
          response == "Irrelevant" ~ "Marriage is irrelevant",
          response == "Refusal" ~ "Refusal of marriage",
          response == "Economic" ~ "Economic reasons",
          response == "Trial" ~ "Trial marriage",
          response == "Prelude" ~ "Prelude to marriage",
          TRUE ~ response
        )
      ) |> 
    pivot_wider(
      id_cols = response, 
      names_from = year, 
      names_prefix = "year_",
      values_from  = percentage
      ) |>
      mutate(pp_change = year_2021 - year_2005) |> 
      group_by(response) |> 
      mutate(max = max(year_2005, year_2021)) |> 
      ungroup() |> 
      pivot_longer(cols = c(year_2005, year_2021),
                   names_to = "year",
                   names_prefix = "year_",
                   values_to = "percentage") |> 
      select(-percentage),
    by = join_by(response, year)
  ) |> 
  
  # block of code for calculaing pp change between rounds on types
  left_join(
    figure4 |>
      mutate(across(where(is.numeric), ~round(. * 100))) |>
      rename(
        type = big_type,
        response = typ,
        percentage = prop,
        percentage_type = prob_big,
        year = survey 
      ) |>
      mutate(
        response = case_when(
          response == "Irrelevant" ~ "Marriage is irrelevant",
          response == "Refusal" ~ "Refusal of marriage",
          response == "Economic" ~ "Economic reasons",
          response == "Trial" ~ "Trial marriage",
          response == "Prelude" ~ "Prelude to marriage",
          TRUE ~ response
        )
      ) |> 
      group_by(type, year) %>%  
      summarise(percentage_type = max(percentage_type)) %>% 
      pivot_wider(id_cols = type, names_from = year, values_from = percentage_type) %>% 
      mutate(pp_change_type = `2021` - `2005`) %>%  
      
      # find max type
      group_by(type) %>%  
      mutate(max_type=max(`2021`, `2005`)) %>%  
      ungroup() %>%  
      
      pivot_longer(cols  = c(`2021`, `2005`), names_to = "year", values_to = "percentage_type") |> 
      select(-percentage_type)
    ,by = join_by("type", "year")) |> 
  arrange(type, response)
```

```{r massaging-variables-figure5}
figure5proper <- figure5 |> 
  mutate(across(where(is.numeric), ~round(. * 100))) |>
  rename(
    response = typ,
    percentage = prop,
    age_group = age4,
    year = survey 
  ) |> 
  select(-contains("weight")) |> 
  left_join(
    figure5 |> 
      mutate(across(where(is.numeric), ~round(. * 100))) |>
      rename(
        response = typ,
        percentage = prop,
        age_group = age4,
        year = survey 
      ) |> 
      pivot_wider(id_cols = c(response, age_group),
                  values_from = percentage,
                  names_from = year,
                  names_prefix = "year_") |>
      group_by(response, age_group) |> 
      mutate(max = max(year_2021, year_2005)) |> 
      ungroup() |> 
      mutate(pp_change = year_2021-year_2005) |> 
      pivot_longer(cols  = c(year_2021, year_2005), names_to = "year", values_to = "percentage", names_prefix = "year_") |>
      select(-percentage),
    by = join_by(response, age_group, year)
  ) |> 
  arrange(response, age_group, year)
```

```{r massaging-variables-figure6}
figure6proper <- figure6 |> 
  mutate(across(where(is.numeric), ~round(. * 100))) |>
  rename(
    response = typ,
    percentage = prop,
    type = edu3,
    year = survey 
  ) |> 
  select(-contains("weight")) |> 
  left_join(
    figure6 |> 
      mutate(across(where(is.numeric), ~round(. * 100))) |>
      rename(
        response = typ,
        percentage = prop,
        type = edu3,
        year = survey 
      ) |> 
      pivot_wider(id_cols = c(response, type),
                  values_from = percentage,
                  names_from = year,
                  names_prefix = "year_") |>
      group_by(response, type) |> 
      mutate(max = max(year_2021, year_2005)) |> 
      ungroup() |> 
      mutate(pp_change = year_2021-year_2005) |> 
      pivot_longer(cols  = c(year_2021, year_2005), names_to = "year", values_to = "percentage", names_prefix = "year_") |>
      select(-percentage),
    by = join_by(response, type, year)
  ) |> 
  arrange(response, type, year) |> 
  mutate(
    type = case_when(
      type == "low" ~ "Low",
      type == "mid" ~ "Medium",
      type == "high" ~ "High"
    )
  )
```

## Theme for figures

```{r message=FALSE}
#load in fonts
loadfonts(device = "win")

# Custom ggplot theme to make pretty plots
# Get the font at https://fonts.google.com/specimen/Jost
theme_nice <- function() {
  theme_minimal(base_family = "Jost") +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          plot.title = element_text(family = "Jost", face = "bold"),
          axis.title = element_text(family = "Jost Medium"),
          axis.title.x = element_text(hjust = 0),
          axis.title.y = element_text(hjust = 1),
          strip.text = element_text(family = "Jost", face = "bold",
                                    size = rel(0.75), hjust = 0),
          strip.background = element_rect(fill = "grey90", color = NA))
}

# Set default theme and font stuff
theme_set(theme_nice())
update_geom_defaults("text", list(family = "Jost", fontface = "plain"))
update_geom_defaults("label", list(family = "Jost", fontface = "plain"))
```

## Figure 4 - by year with aggregation to larger cohabitation types

#### Base plot

```{r}
# set a custom nudge value
nudge_value=1.5

figure_4 <- 
  figure4proper %>% 
  # reordering levels for plotting
  mutate(type = factor(type, levels = c("Forerunners - most likely getting married",
                                         "Forerunners - possibly getting married",
                                         "Alternatives - unlikely to get married"))) %>%  
                                         
  
  # basic mapping and aesthetics
  ggplot(aes(x = percentage, y = response)) +
  
  # Replace geom_line with geom_segment with arrows
  # Arrows for increases (2005 -> 2021)
  # Arrow shaft (line only)
  geom_segment(data = . %>%  
                 group_by(type, response) %>%  
                 arrange(year) %>% 
                 summarise(x_start = first(percentage), 
                           x_end = last(percentage),
                           change = x_end - x_start,
                           .groups = "drop"),
               aes(x = x_start, xend = x_end, y = response, yend = response),
               color = "#E7E7E7",
               linewidth = 3.5) +

  # Arrowhead only (no transparency)
  geom_segment(data = . %>%  
                 group_by(type, response) %>%  
                 arrange(year) %>% 
                 summarise(x_start = first(percentage), 
                           x_end = last(percentage),
                           change = x_end - x_start,
                           # Start arrow closer to the end to avoid overlap
                           x_arrow_start = x_end - (x_end - x_start) * 0.05,
                           .groups = "drop"),
               aes(x = x_arrow_start, xend = x_end, y = response, yend = response),
               color = "#E7E7E7",
               linewidth = 3.5,
               arrow = arrow(length = unit(0.4, "cm"), type = "closed", angle = 25)) +
  
  # adding points
  geom_point(aes(color = year, shape = year), size=3) +
  # shape control
  scale_shape_manual(values = c("2005" = 15,     # filled square
                              "2021" = 16)) +  # filled circle
  
  
  # adding data points
  geom_text(aes(label=percentage, color=year),
            size=3.25,
            nudge_x=if_else(
              figure4proper$percentage==figure4proper$max, # if it's the larger percentage...
              nudge_value,   # move it to the right of the point
              -nudge_value), # otherwise, move it to the left of the point
            hjust=if_else(
              figure4proper$percentage==figure4proper$max, #if it's the larger percentage
              0, # left justify
              1),# else, right justify      
            ) +
  geom_text(aes(label = year, color = year), 
            data=. %>%  filter(response == "Prelude to marriage"),
            nudge_y =.25, 
            fontface="bold",
            size=3.25)+ 
  scale_color_manual(values=c("#436685", "#BF2F24")) +
  facet_wrap(vars(type), nrow = 3, scales = "free_y") +
  labs( 
    y = NULL,
    x = NULL,
    color = "Year"
  ) + 
  
  # changing the x scale
  scale_x_continuous(breaks = seq(0, 50, 10)) +
  coord_cartesian(xlim = c(0, 50)) +
  
  theme_nice() +
  theme(legend.position = "none") 
  

figure_4

ggsave(
  filename = file.path("plots", "figure_4.png"),
  plot = figure_4,
  width = 4.9,
  height = 5.5,
  units = "in",
  dpi = 300,
  bg = "white"
)
```

#### Aggregated plot

```{r}
nudge_value=1.5

figure4_aggr <- 
  figure4proper %>%  
  group_by(type, year) %>%  
  summarise(pp_change = max(pp_change_type),
            max = max(max_type),
            percentage = max(percentage_type))

figure_4a <- 
  figure4_aggr %>%  
  mutate(type = factor(type, levels = c("Alternatives - unlikely to get married",
                                         "Forerunners - possibly getting married",
                                         "Forerunners - most likely getting married"))) %>%  
  # plotting
  ggplot(aes(x = percentage, y = type)) +
  # Replace geom_line with geom_segment with arrows
  geom_segment(data = . %>%  
                 group_by(type) %>%  
                 arrange(year) %>% 
                 summarise(x_start = first(percentage), 
                           x_end = last(percentage),
                           .groups = "drop"),
               aes(x = x_start, xend = x_end, y = type, yend = type),
               color = "#E7E7E7",
               linewidth = 3.5,
               arrow = arrow(length = unit(0.5, "cm"), type = "closed", angle = 25)) +
  
  geom_point(aes(color=year, shape = year), size=3) +
  # shape control
  scale_shape_manual(values = c("2005" = 15,     # filled square
                              "2021" = 16)) +  # filled circle

  
  # adding data points
  geom_text(aes(label=percentage, color=year),
            size=3.25,
            nudge_x=if_else(
              figure4_aggr$percentage==figure4_aggr$max,
              nudge_value,
              -nudge_value),
            hjust=if_else(
              figure4_aggr$percentage==figure4_aggr$max,
              0,
              1)) +
  
  # legend
  # 2005 label
  geom_text(aes(label = year, color = year), 
            data = . %>% filter(type == "Forerunners - most likely getting married" & year == 2005),
            nudge_y = 0.25,
            nudge_x = 2,  # nudge left
            fontface = "bold",
            size = 3.25) +

# 2021 label  
  geom_text(aes(label = year, color = year), 
            data = . %>% filter(type == "Forerunners - most likely getting married" & year == 2021),
            nudge_y = 0.25,
            nudge_x = -2,   # nudge right
            fontface = "bold",
            size = 3.25) +
  
  # control over year colours:
  scale_color_manual(values=c("#436685", "#BF2F24")) +
  
  # add line breaks to y-axis labels
  scale_y_discrete(labels = c("Alternatives - unlikely\nto get married",
                               "Forerunners - possibly\ngetting married",
                               "Forerunners - most likely\ngetting married")) +
  # changing the x scale
  scale_x_continuous(breaks = seq(0, 50, 10)) +
  coord_cartesian(xlim = c(0, 50)) +
  
  # labels
  labs(
    y = NULL,
    x = NULL,
    color = "Year"
  ) +
  
  # theme control:
  theme_nice() +
  theme(legend.position = "none")


figure_4a

ggsave(
  filename = file.path("plots", "figure_4a.png"),
  plot = figure_4a,
  width = 4.9,
  height = 3,       # shorter since it's just 3 rows
  units = "in",
  dpi = 300,
  bg = "white"
)
```

#### Trying to paste the plots onto each other

```{r}
figure_4complete_plot <- 
  figure_4 + figure_4a +
  plot_layout(ncol = 1, heights = c(5.5, 3))

ggsave(
  filename = file.path("plots", "figure_4complete.png"),
  plot = figure_4complete_plot,
  width = 4.9,
  height = 8.5,
  units = "in",
  dpi = 300,
  bg = "white"
)
```

## Figure 5 - by generation

```{r}
# set a custom nudge value
nudge_value=.3

figure_5 <- 
  figure5proper %>%  
  # Reordering the response vars
  mutate(
    response = factor(response,
                     levels = c("Prelude", 
                                "Trial",
                                "Refusal",
                                "Conformist", 
                                "Economic", 
                                "Irrelevant"),
                     labels = c("Prelude to marriage",
                                "Trial marriage",
                                "Refusal",
                                "Conformist", 
                                "Economic reasons", 
                                "Marriage is irrelevant"))
  ) %>%  
  
  # basic setup
  ggplot(aes(x = year, y = percentage, color = age_group, group = age_group, linetype = age_group, shape = age_group)) +
  geom_line() +
  # controlling linetype
  scale_linetype_manual(values = c("18-34" = "solid", 
                                  "35-51" = "dashed", 
                                  "52-69" = "dotted")) +

  geom_point() + 
  
  # text variable
  ggrepel::geom_text_repel(
    aes(label = percentage),
    size = 3.25,
    direction = "both",  # or "x" for horizontal only, "y" for vertical only
    box.padding = 0.35,  # adjust spacing around text
    point.padding = 0.5, # distance from points
    segment.size = 0.2,  # line thickness
    segment.alpha = 0.5, # line transparency
    min.segment.length = 0.1, # shorter segments
    force = 0.3,         # repulsion force
    max.iter = 3000,     # more iterations for better placement
    nudge_x = if_else(
      figure5proper$year == min(figure5proper$year), 
      -0.3, 0.3
    ), show.legend = FALSE) +
  
  
  facet_wrap(vars(response)) +
  
  #labs
  labs(
    x = NULL,
    y = NULL,
    color = "Age group",
    linetype = "Age group",
    shape = "Age group"
  ) +
  
  # themes
  theme_nice() +
  theme(legend.position = "bottom")

figure_5

ggsave(
  filename = file.path("plots", "figure_5.png"),
  plot = figure_5,
  width = 4.9,
  height = 5.7,     # use full height for grid layout
  units = "in",
  dpi = 300,
  bg = "white"
)
```

## Figure 6 - by education

```{r}
# set a custom nudge value
nudge_value=.3

figure_6 <- 
  figure6proper %>%  
  # Reordering the response vars
  mutate(
    response = factor(response,
                     levels = c("Prelude", 
                                "Trial",
                                "Refusal",
                                "Conformist", 
                                "Economic", 
                                "Irrelevant"),
                     labels = c("Prelude to marriage",
                                "Trial marriage",
                                "Refusal",
                                "Conformist", 
                                "Economic reasons", 
                                "Marriage is irrelevant")),
    type = factor(type,
                  levels = c("Low",
                             "Medium",
                             "High"))
  ) %>%  
  
  # basic setup
  ggplot(aes(x = year, y = percentage, color = type, group = type, linetype = type, shape = type)) +
  geom_line() +
  # controlling linetype
  scale_linetype_manual(values = c("Low" = "solid", 
                                  "Medium" = "dashed", 
                                  "High" = "dotted")) +
  geom_point() + 
  
  # text variable
  ggrepel::geom_text_repel(
    aes(label = percentage),
    size = 3.25,
    direction = "both",  # or "x" for horizontal only, "y" for vertical only
    box.padding = 0.35,  # adjust spacing around text
    point.padding = 0.5, # distance from points
    segment.size = 0.2,  # line thickness
    segment.alpha = 0.5, # line transparency
    min.segment.length = 0.1, # shorter segments
    force = 0.3,         # repulsion force
    max.iter = 3000,     # more iterations for better placement
    nudge_x = if_else(
      figure5proper$year == min(figure5proper$year), 
      -0.3, 0.3
    ), show.legend = FALSE) +
  
  # scale fix
  scale_y_continuous(breaks = seq(0, 40, 10)) +
  coord_cartesian(ylim = c(0, 40)) +
  
  facet_wrap(vars(response)) +
  
  #labs
  labs(
    x = NULL,
    y = NULL,
    color = "Education",
    linetype = "Education",
    shape = "Education"
  ) +
  
  # themes
  theme_nice() +
  theme(legend.position = "bottom")

figure_6

ggsave(
  filename = file.path("plots", "figure_6.png"),
  plot = figure_6,
  width = 4.9,
  height = 5.7,     # use full height for grid layout
  units = "in",
  dpi = 300,
  bg = "white"
)
```
